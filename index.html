<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spin & Win - Sepolia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #181c2a; color: #fff; }
        .container { max-width: 600px; margin: 40px auto; background: #23284a; border-radius: 16px; padding: 32px; }
        .wheel { margin: 32px auto; width: 320px; height: 320px; border-radius: 50%; border: 8px solid #FFD700; position: relative; background: #222; }
        .wheel-segment { position: absolute; width: 50%; height: 50%; left: 50%; top: 50%; transform-origin: 0% 100%; }
        .wheel-label { position: absolute; left: 60%; top: 60%; color: #fff; font-size: 1rem; text-align: center; width: 80px; }
        .highlight { box-shadow: 0 0 30px 10px #FFD700, 0 0 10px 2px #fff; border-radius: 50%; z-index: 2; }
        .pointer { position: absolute; left: 50%; top: -30px; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-bottom: 40px solid #FFD700; }
        button { padding: 12px 32px; border-radius: 8px; border: none; background: #FFD700; color: #222; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin: 8px 0; }
        .info { margin: 16px 0; }
        .notification { margin: 12px 0; color: #FFD700; }
    </style>
</head>
<body>
<div class="container">
    <h2>Spin & Win (Sepolia)</h2>
    <div>
        <button id="connectBtn" onclick="connectWallet()">Cüzdanı Bağla</button>
        <span id="walletAddress"></span>
    </div>
    <div class="info">
        <div>Havuz: <span id="prizePool">0</span> ETH</div>
        <div>Bekleyen Ödül: <span id="pendingReward">0</span> ETH</div>
        <div>Toplam Spin: <span id="totalSpins">0</span></div>
        <div>Toplam Kazanç: <span id="totalClaimed">0</span> ETH</div>
    </div>
    <div class="wheel" id="wheel">
        <div class="pointer"></div>
        <!-- Segmentler JS ile eklenecek -->
    </div>
    <div>
        <input type="number" id="spinCount" min="1" max="100" value="1" style="width:60px;">
        <button onclick="spin()">Spin</button>
        <button onclick="claimReward()">Ödül Çek</button>
    </div>
    <div class="notification" id="notification"></div>
</div>
<script>
const SEPOLIA_CHAIN_ID = '0xaa36a7';
const contractAddress = "0xe2523b54d1503768dd2e2325941e1dc0115c2cb1";
const contractABI = [
  {
    "inputs": [{"internalType": "uint256","name": "spinCount","type": "uint256"}],
    "name": "calculateSpinCost",
    "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
    "stateMutability": "pure","type": "function"
  },
  {
    "inputs": [{"internalType": "address","name": "user","type": "address"}],
    "name": "getUserData",
    "outputs": [
      {"internalType": "uint256","name": "pendingReward","type": "uint256"},
      {"internalType": "uint256","name": "totalWins","type": "uint256"},
      {"internalType": "uint256","name": "totalSpins","type": "uint256"},
      {"internalType": "uint256","name": "totalWagered","type": "uint256"},
      {"internalType": "uint256","name": "totalClaimed","type": "uint256"},
      {"internalType": "uint256","name": "winRate","type": "uint256"}
    ],
    "stateMutability": "view","type": "function"
  },
  {
    "inputs": [],"name": "getCurrentPrizes",
    "outputs": [{"internalType": "uint256[10]","name": "","type": "uint256[10]"}],
    "stateMutability": "view","type": "function"
  },
  {
    "inputs": [],"name": "prizePool",
    "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
    "stateMutability": "view","type": "function"
  },
  {"inputs": [{"internalType": "uint256","name": "spinCount","type": "uint256"}],"name": "spin","outputs": [],"stateMutability": "payable","type": "function"},
  {"inputs": [],"name": "claimReward","outputs": [],"stateMutability": "nonpayable","type": "function"}
];

let provider, signer, contract, userAddress;
const segmentLabels = [
    "LOSE", "LOSE", "LOSE", "5%", "10%", "15%", "20%", "LOSE", "30%", "JACKPOT"
];

async function connectWallet() {
    if (!window.ethereum) return notify('Metamask gerekli!');
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    if (chainId !== SEPOLIA_CHAIN_ID) {
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: SEPOLIA_CHAIN_ID }]
        });
    }
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();
    contract = new ethers.Contract(contractAddress, contractABI, signer);
    document.getElementById('walletAddress').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
    notify('Cüzdan bağlandı!');
    await updateAllData();
    renderWheel();
}

function notify(msg) {
    document.getElementById('notification').textContent = msg;
    setTimeout(() => { document.getElementById('notification').textContent = ''; }, 4000);
}

async function updateAllData() {
    if (!contract || !userAddress) return;
    try {
        const [pendingReward, , totalSpins, , totalClaimed] = await contract.getUserData(userAddress);
        const prizePool = await contract.prizePool();
        const currentPrizes = await contract.getCurrentPrizes();
        document.getElementById('prizePool').textContent = ethers.formatEther(prizePool);
        document.getElementById('pendingReward').textContent = ethers.formatEther(pendingReward);
        document.getElementById('totalSpins').textContent = totalSpins;
        document.getElementById('totalClaimed').textContent = ethers.formatEther(totalClaimed);
        // Güncel ödülleri çark segmentlerine yaz
        for (let i = 0; i < 10; i++) {
            const label = document.getElementById('segLabel'+i);
            if (label) label.innerHTML = segmentLabels[i] + '<br><b>' + ethers.formatEther(currentPrizes[i]) + ' ETH</b>';
        }
    } catch (e) {
        notify('Veri çekilemedi: ' + e.message);
    }
}

function renderWheel() {
    const wheel = document.getElementById('wheel');
    wheel.innerHTML = '<div class=\"pointer\"></div>';
    for (let i = 0; i < 10; i++) {
        const seg = document.createElement('div');
        seg.className = 'wheel-segment';
        seg.style.transform = `rotate(${i*36}deg) skewY(-54deg)`;
        seg.innerHTML = `<div class=\"wheel-label\" id=\"segLabel${i}\">${segmentLabels[i]}<br><b>0 ETH</b></div>`;
        wheel.appendChild(seg);
    }
}

async function spin() {
    if (!contract) return notify('Cüzdan bağlı değil!');
    const spinCount = parseInt(document.getElementById('spinCount').value) || 1;
    try {
        const cost = await contract.calculateSpinCost(spinCount);
        const tx = await contract.spin(spinCount, { value: cost });
        notify('Spin işlemi gönderildi!');
        await tx.wait();
        notify('Spin işlemi onaylandı, sonuç bekleniyor...');
        setTimeout(updateAllData, 5000);
    } catch (e) {
        notify('Spin hatası: ' + e.message);
    }
}

async function claimReward() {
    if (!contract) return notify('Cüzdan bağlı değil!');
    try {
        const tx = await contract.claimReward();
        notify('Çekim işlemi gönderildi!');
        await tx.wait();
        notify('Ödül çekildi!');
        updateAllData();
    } catch (e) {
        notify('Çekim hatası: ' + e.message);
    }
}

window.addEventListener('load', () => {
    renderWheel();
});
</script>
</body>
</html>
